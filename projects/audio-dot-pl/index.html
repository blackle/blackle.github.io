<!DOCTYPE html>
<html xmlns:fb="http://ogp.me/ns/fb#">
  <head>
    <title>audio.pl - Blackle Mori</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico"/>
    <meta property="og:image" content="/images/logo.gif" />
    <meta property="og:site_name" content="Blackle-Mori"/>
    <meta name="viewport" content="initial-scale=0.6, width=device-width" />
    <meta name="author" content="Blackle Mori" />
    <link href="/index.css" type="text/css" rel="stylesheet" media="not print" />
    <link href="/print.css" type="text/css" rel="stylesheet" media="print" />
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61976242-1', 'auto');
  ga('send', 'pageview');

</script>
  </head>
  <body>
    <header>
      <h1>Blackle-Mori</h1>
      <nav>
        <ul>
          <li><a href="/">about</a></li>
          <li><a href="/portfolio/">portfolio</a></li>
          <li><a href="/projects/">projects</a></li>
          <li><a href="/links/">links</a></li>
        </ul>
      </nav>
    </header>
    <main>
<article class="main-article">

<h2>audio.pl</h2>
<time datetime="2015-01-27">Posted on Tue Jan 27, 2015 by Isabelle Knott</time>
<p>I've recently been "getting into" the demoscene. Getting into is in quotes because I live in North America and there are no demoparties within 50 km of me, so all I can do is read old Hugi articles and watch videos from pouet.</p>
<p>In the interest of doing something productive, I decided to make my own demo.</p>
<hr/>
<p>The goal for my demo was to get it less than 4k. I don't know openGL, but I do know how to make audio samples. I decided I would make an audio only demo. Concurrently, I've also been steadily going through a massive PDF of old perl golf tournaments. I've always been fascinated by how tiny you can make programs in perl. Then I thought "hey, what if I wrote part of my demo in perl?"</p>
<p>So I did. I wrote a little perl script that generates samples, and when you play the samples back you get a proportionally little song. I didn't want to make the demo entirely in perl and trust the interpreter directive because thats no fun. Instead, I wrote a kind of "launcher" in c that does the following:</p>
<ol>
  <li> Stores a gzipped compressed version of the perl code in the data segment. </li>
  <li> Opens up a connection to the audio server. </li>
  <li> Sets up a piping system like this: <span class="pre">c-code | gzip | perl | c-code</span> </li>
  <li> Starts writing the gzipped perl code into gzip, gzip pipes it to perl, perl executes it. </li>
  <li> Reads the samples generated by the perl code and sends them to the audio server </li>
</ol>
<p>The perl code is about 1.5k, gzipped its about 700 bytes. The c code, however, is 2.3k, and when you compile it with <span class="pre">gcc -o audio audio.c</span> you get an executable thats over 16k.</p>
<p>The executable is big for a few reasons. Firstly, there is a lot of debug information in the executable that programs like gdb use to get line number information. Secondly, when you use a lot of library functions, as is necessary for opening sound server connections, the ELF's Procedure Linkage Table (PLT) grows large. Thirdly, the c startfiles (crt0 and the like) tend to be very disproportionately big in comparison to a tiny program.</p>
<p>Fixing the first problem is done by adding extra options to the <span class="pre">gcc</span> command. The options <span class="pre">-s -g0 -Os</span> strip useless information, disable debug info, and enable size optimization respectively. This shaved about 6k off my program.</p>
<p>The second problem can be avoided by doing whats called "manual linking." <a href="http://stackoverflow.com/questions/10551665/how-to-create-4kb-linux-binaries">This stackoverflow answer</a> pointed me in the right direction. What you do is, instead of trusting the linker to find the function offsets for you, you do them yourself with calls to <span class="pre">dlopen</span> and <span class="pre">dlsym</span>. These functions give you pointers to functions. This ended up cutting a few hundred bytes off my executable, because now the PLT only has these two functions in it.</p>
<p>Finally, I stopped using startfiles altogether by adding the options <span class="pre">-nostartfiles -nostdlib</span> to my compiler string. This brought the program almost the rest of the way, but I was still sitting a touch above my goal of 4k. It also started to segfault every time I connected to the audio server.</p>
<p>It stopped working because (I'm hypothesizing here) pulseaudio assumes startfiles are being used, so it tries to access memory it assumes was allocated by them. Or, its following a pointer to nowhere. I don't know. The point is, it breaks.</p>
<p>To solve the problem I did something pretty bad. Often when you install ALSA or pulseaudio you get some utility programs as well. Specifically I'm talking about <span class="pre">aplay</span> and <span class="pre">paplay</span>. Both are command line programs that send raw data to the sound server. I decided to offload the actual playback stuff to one of these programs, using the c code to exclusively set up the <span class="pre">gzip | perl | aplay/paplay</span> scaffolding.</p>
<p>By assuming the existence of certain programs on the system, I was able to get my program well below 4k (3712 bytes). I think I can get that value smaller by re-writing the thing in assembly, because the only functions I'm using are system calls.</p>
<p>I've put the c file, the header that includes the gzipped perl code and a makefile into <a href="/stuff/audio-dot-pl/audio.zip">this zip file</a> so you can enjoy the song yourself.</p>
<div class="twitter-button"><a href="https://twitter.com/share" class="twitter-share-button" data-via="blacklemon67" data-dnt="true">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</div>
<div class="clearfix"></div></article>
    </main>
  </body>
</html>
